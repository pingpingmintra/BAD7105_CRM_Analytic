CREATE OR REPLACE TABLE `churn-334305.supermarket.dataset`
  AS SELECT PARSE_DATE("%Y%m%d", SAFE_CAST(SHOP_DATE AS STRING)) AS SHOP_DATE, CUST_CODE
  FROM `churn-334305.supermarket.data`
  WHERE CUST_CODE IS NOT NULL
  ORDER BY SHOP_DATE;


WITH temp1 AS (
  SELECT CUST_CODE,
    FORMAT_DATE('%Y-%m', DATE(SHOP_DATE)) SHOP_MONTH, 
    DATE_DIFF(DATE(SHOP_DATE), '2000-01-01', MONTH) pos,
    DATE_DIFF(DATE(MIN(SHOP_DATE) OVER(PARTITION BY CUST_CODE)), '2000-01-01', MONTH) first_pos
  FROM `churn-334305.supermarket.dataset` 
), temp2 AS (
  SELECT *, pos = first_pos AS new_cus
  FROM temp1
), temp3 AS (
  SELECT *, LAST_VALUE(new_cus) OVER(win) OR pos - 1 = LAST_VALUE(pos) OVER(win) AS repeat_cus
  FROM temp2
  WINDOW win AS (PARTITION BY CUST_CODE ORDER BY pos RANGE BETWEEN 1 PRECEDING AND 1 PRECEDING)
),
  temp4 AS (
  SELECT *,LAST_VALUE(new_cus) OVER(win) IS NULL OR pos = LAST_VALUE(pos) OVER(win) AS churned_cus
  FROM temp3
  WINDOW win AS (PARTITION BY CUST_CODE ORDER BY pos RANGE BETWEEN 1 PRECEDING AND 1 PRECEDING) 
),
  temp5 AS (
  SELECT *, pos-2 = LAST_VALUE(pos) OVER(win) AS reactivate_cus
  FROM temp4
  WINDOW win AS (PARTITION BY CUST_CODE ORDER BY pos RANGE BETWEEN 2 PRECEDING AND 1 PRECEDING) 
),
  final AS (
  SELECT SHOP_MONTH, CUST_CODE,
  CASE 
   WHEN new_cus = true THEN 'New'
   WHEN repeat_cus = true THEN 'Repeated'
   WHEN reactivate_cus = true THEN 'Reactivated' 
   WHEN churned_cus = true THEN 'Churned'
   
  END AS status,
  FROM temp5
)
  
  
SELECT SHOP_MONTH, status, 
  if (status='Churned',-1*COUNT(DISTINCT CUST_CODE),COUNT(DISTINCT CUST_CODE)) COUNT 
FROM final
WHERE status IS NOT NULL 
GROUP BY SHOP_MONTH, status
ORDER BY SHOP_MONTH
